@model List<BetterTeamsWebApp.Models.ViewModels.MessageVM>
@{

    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="container">
    <div class="messaging">
        <div class="inbox_msg">
            <div class="mesgs">
                <div id="chatBox" class="msg_history">

                </div>
                <!--Type Message-->
                <div class="type_msg ">
                    <div class="input_msg_write">
                        <input id="msg" class="write_msg" placeholder="Type a message" />
                        <button id="btn" class="msg_send_btn">s</button>
                        <input type="hidden" id="OtherUser" value="@ViewBag.OtherUser" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@*<script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>*@
@section scripts{
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.4.0.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<!--SignalR script to update the chat page and send messages.-->

<script>
    function Now() {
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1; //January is 0!
        var yyyy = today.getFullYear();

        var hh = today.getHours();
        var min = today.getMinutes();
        var ss = today.getSeconds();

        if (dd < 10) {
            dd = '0' + dd;
        }
        if (mm < 10) {
            mm = '0' + mm;
        }
        var today = dd + '/' + mm + '/' + yyyy + ' ' + hh + ':' + min + ':' + ss;
        return today;
    }

    var UserTo;
    function setUser(id) {
        UserTo = document.getElementById(`${id}`).getAttribute("value");
        let c = document.getElementById("chatBox");
        c.innerHTML = "";
        message(UserTo);
    }


    var message = (To) => {
        $.ajax({
            url: '/Home/GetMessages',
            type: 'Post',
            data: {UserTo: `${To}`},
            dataType: 'json',
            success: function (List) {
                messageListSuccess(List);
            },
            error: function (request, message, error) {
                console.log(request);
                console.log(error);
                console.log(message);
            }

        });
    }

    var messageListSuccess = (Msges) => {

        $.each(Msges, function (index, txt) {
            addMessage(txt);
        });
    }
    

    $(function () {
        
        var UserCId = (name) => {
            UserCId.username = name
        }

        let b = true;

        var chat = $.connection.chatHub;
        let btn = document.getElementById("btn");
        let message = document.getElementById("msg");
        chat.addNewMessageToPage = function () {
            addMessage(message.value);
        };

        var UserName = "@User.Identity.Name";
        var chHub = $.connection.chatHub;
        chHub.client.userConnected = (UserName) => {
            chat.users.push(new UserCId(UserName));
        };

        chHub.client.received = (data) => {
            
            SignalMessage(data);
        };

       

        let startConnection = () => {
            $.connection.hub.start().done(function () {
                message.addEventListener("keyup", (event) => {
                    //event.preventDefault();
                    
                    if (event.keyCode === 13) {
                        chat.server.send(message.value, UserTo);
                        let d = Now();
                        m = new Object();
                        m.Text = message.value;
                        m.Sender = "@User.Identity.Name";
                        m.DateTime = d;
                        //Comment this!!!
                        //addMessage(m);
                        message.value = "";
                    }
                });

                btn.addEventListener("click", (event) => {
                    chat.server.send(message.value, UserTo);
                    message.value = "";
                });
            });
        }

        startConnection();
    });


    let SignalMessage = (m) => {
        let msgBubble;
        let CurrentUser = "@User.Identity.Name";
        let d = Now();
        
        if (m.sender === CurrentUser) {

            msgBubble = '<div class="outgoing_msg">' +
                '<div class="sent_msg">' +
                '<span class="time_user">' + m.sender + '</span>' +
                '<p>' + m.Message + '</p>' +
                '<div id=""></div>' +
                '<span class="time_user">' + d + '</span>' +
                '</div></div></div>';
        } else {
            msgBubble = '<div class="incoming_msg">' +
                '<div class="received_msg">' +
                '<div class="received_withd_msg">' +
                '<span class="time_user">' + m.sender + '</span>' +
                '<p>' + m.Message + '</p>' +
                '<div></div>' +
                '<span class="time_user">' + d + '</span>' +
                '</div></div></div>';
        }
        let chatBox = document.getElementById("chatBox");
        chatBox.innerHTML += msgBubble;
    }
    






    //--------------------------------------------------------------------
   

    //var sendMessageSuccess = (message) => {
    //    console.log("Message sent!!!");
    //    let nm = addMessage(message);
    //    let chatBox = document.getElementById("chatBox");
    //    chatBox.innerHTML += nm;
    //    msg.value = "";
    //}

    //test
    

    // Handles sendMessage event on send button
    @*function sendBtn() {
        let d = new Date();
        newMessage = new Object();
        newMessage.Text = msg.value;
        newMessage.Sender = "@User.Identity.Name";
        newMessage.Receiver = 'petros_sa';
        //console.log(newMessage);
        $.ajax({
            url: "/Home/PostMessage",
            type: "post",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(newMessage),
            success: function (newMessage) {
                sendMessageSuccess(newMessage);
            },
            error: function (request, message, error) {
                console.log(request);
                console.log(error);
                console.log(message);
            }
        });

    }*@

    //Message Builder
    let addMessage = (m) => {
        let msgBubble;
        let CurrentUser = "@User.Identity.Name";
        
            //console.log(newMessage);
        if (m.Sender === CurrentUser) {

            msgBubble = '<div class="outgoing_msg">' +
                '<div class="sent_msg">' +
                '<span class="time_user">' + m.Sender + '</span>' +
                '<p>' + m.Text + '</p>' +
                '<span class="time_user">' + m.DateTime + '</span>' +
                '</div></div></div>';
        } else {
            msgBubble = '<div class="incoming_msg">' +
                '<div class="received_msg">' +
                '<div class="received_withd_msg">' +
                '<span class="time_user">' + m.Sender + '</span>' +
                '<p>' + m.Text + '</p>' +
                '<span class="time_user">' + m.DateTime + '</span>' +
                '</div></div></div>';
        }
        let chatBox = document.getElementById("chatBox");
        chatBox.innerHTML += msgBubble;
    }


</script>
 }  



