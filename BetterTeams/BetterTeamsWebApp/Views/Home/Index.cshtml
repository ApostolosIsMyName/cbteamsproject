@model List<BetterTeamsWebApp.Models.ViewModels.MessageVM>
@{

    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="container">
    <div class="messaging">
        <div class="inbox_msg">
            <div class="mesgs">
                <div id="chatBox" class="msg_history">

                </div>
                <!--Type Message-->
                <div class="type_msg ">
                    <div class="input_msg_write">
                        <input id="msg" class="write_msg" placeholder="Type a message" />
                        <button id="btn" class="msg_send_btn" onclick="sendBtn();">s</button>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>

<!--Reference the SignalR library. -->
@*<script src="~/Scripts/jquery.signalR-2.4.0.js"></script>*@
<!--Reference the autogenerated SignalR hub script. -->
@*<script src="~/signalr/hubs"></script>*@
<!--SignalR script to update the chat page and send messages.-->

<script>
    var message = () => {
        $.ajax({
            url: '/Home/GetMessages',
            type: 'GET',
            dataType: 'json',
            success: function (List) {
                messageListSuccess(List);
            },
            error: function (request, message, error) {
                console.log(request);
                console.log(error);
                console.log(message);
            }

        });
    }



    //test
    var messageListSuccess = (Msges) => {

        $.each(Msges, function (index, txt) {
            let m = addMessage(txt);
            let chatBox = document.getElementById("chatBox");
            chatBox.innerHTML += m;
            console.log("messages projected");
        });
    }

    // Handles sendMessage event on send button
    function sendBtn() {
        let d = new Date();
        newMessage = new Object();
        newMessage.Message = document.getElementById("msg").value;
        newMessage.DateTime = `${d.getDate}/${d.getMonth}/${d.getFullYear} ${d.getHours}/${d.getMinutes}/${d.getSeconds}`;
        newMessage.Sender = 'test';
        newMessage.Receiver = 'panospap';
        //console.log(newMessage);
        $.ajax({
            url: "/Home/PostMessage",
            type: "post",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(newMessage),
            success: function (messageVM) {
                console.log("Message sent!!!");
                let m = addMessage(messageVM);
                let chatBox = document.getElementById("chatBox");
                chatBox.innerHTML += m;
            },
            error: function (request, message, error) {
                console.log(request);
                console.log(error);
                console.log(message);
            }
        });

    }

    //Message Builder
    let addMessage = (newMessage) => {
        let msgBubble;
        console.log('addMessage run');
        let CurrentUser = "@User.Identity.Name";
        //console.log(newMessage);
        if (newMessage.Sender === CurrentUser) {

            msgBubble = '<div class="outgoing_msg">' +
                        '<div class="sent_msg">' +
                        '<span class="time_user">'+ newMessage.Sender + '</span>'+
                        '<p>' + newMessage.Message + '</p>'+
                        '<span class="time_user">' + newMessage.DateTime + '</span>' +
                        '</div></div></div>';      
        } else {
            msgBubble = '<div class="incoming_msg">' +
                '<div class="received_msg">' +
                '<div class="received_withd_msg">' +
                '<span class="time_user">' + newMessage.Sender + '</span>' +
                '<p>' + newMessage.Message + '</p>' +
                '<span class="time_user">' + newMessage.DateTime + '</span>' +
                '</div></div></div>';
        }
        return msgBubble;
    }


    //window.addEventListener("load", () => {


    //    let chatBox = document.getElementById("chatBox");
    //    const btn = document.getElementById("btn")

    //    msg.addEventListener("keyup", (event) => {
    //        event.preventDefault();
    //        if (event.keyCode === 13) {
    //            let msg = document.getElementById("msg");

    //            chatBox.innerHTML += `
    //                       <div class="outgoing_msg">
    //                            <div class="sent_msg">
    //                                <p>
    //                                    ${msg.value}
    //                                </p>
    //                                <span class="time_date"> 11:01 AM | June 9</span>
    //                            </div>
    //                       </div>`;
    //            msg.value = "";
    //        }
    //    });

    //    btn.addEventListener("click", () => {
    //        let msg = document.getElementById("msg");
    //        chatBox.innerHTML += `
    //                       <div class="outgoing_msg">
    //                            <div class="sent_msg">
    //                                <p>
    //                                    ${msg.value}
    //                                </p>
    //                                <span class="time_date"> 11:01 AM | June 9</span>
    //                            </div>
    //                       </div>`;
    //        msg.value = "";
    //    });

    //});
    window.addEventListener("load", () => {
        message();
    });
</script>



