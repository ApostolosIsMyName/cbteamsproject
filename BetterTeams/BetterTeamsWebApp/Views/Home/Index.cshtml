@model List<BetterTeamsWebApp.Models.ViewModels.MessageVM>
@{

    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="container">
    <div class="messaging">
        <div class="inbox_msg">
            <div class="mesgs">
                <div id="chatBox" class="msg_history">

                </div>
                <!--Type Message-->
                <div class="type_msg ">
                    <div class="input_msg_write">
                        <input id="msg" class="write_msg" placeholder="Type a message" />
                        <button id="btn" class="msg_send_btn">s</button>
                    </div>
                </div>
                <input type="hidden" id="OtherUsername" value="petros_sa" />

            </div>
        </div>
    </div>
</div>

@*<script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>*@
@section scripts{
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.4.0.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<!--SignalR script to update the chat page and send messages.-->

<script>
    $(function () {
        var chat = $.connection.chatHub;
        let message = document.getElementById("msg");
        chat.addNewMessageToPage = function () {
            addMessage(message.value);
        };


        $.connection.hub.start().done(function () {
            message.addEventListener("keyup", (event) => {
                //event.preventDefault();
                if (event.keyCode === 13) {
                    chat.server.send(message.value, "petros_sa", false);
                    message.value = "";
                }
            });

            message.addEventListener("click", (event) => {
                chat.server.send(message.value, "petros_sa");
                message.value = "";
            });
        });

    });
 






    //--------------------------------------------------------------------
    var message = () => {
        ConvDetails = new Object();
        ConvDetails.CurrentUser = "@User.Identity.Name";
        ConvDetails.OtherUser = document.getElementById("OtherUsername").value;
        
        $.ajax({
            url: '/Home/GetMessages',
            type: 'get',
            dataType: 'json',
            success: function (List) {
                messageListSuccess(List);
            },
            error: function (request, message, error) {
                console.log(request);
                console.log(error);
                console.log(message);
            }

        });
    }

    //var sendMessageSuccess = (message) => {
    //    console.log("Message sent!!!");
    //    let nm = addMessage(message);
    //    let chatBox = document.getElementById("chatBox");
    //    chatBox.innerHTML += nm;
    //    msg.value = "";
    //}

    //test
    var messageListSuccess = (Msges) => {

        $.each(Msges, function (index, txt) {
            let m = addMessage(txt);
            let chatBox = document.getElementById("chatBox");
            chatBox.innerHTML += m;
            console.log("messages projected");
        });
    }

    // Handles sendMessage event on send button
    @*function sendBtn() {
        let d = new Date();
        newMessage = new Object();
        newMessage.Text = msg.value;
        newMessage.Sender = "@User.Identity.Name";
        newMessage.Receiver = 'petros_sa';
        //console.log(newMessage);
        $.ajax({
            url: "/Home/PostMessage",
            type: "post",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(newMessage),
            success: function (newMessage) {
                sendMessageSuccess(newMessage);
            },
            error: function (request, message, error) {
                console.log(request);
                console.log(error);
                console.log(message);
            }
        });

    }*@

    //Message Builder
    let addMessage = (m) => {
        
        console.log(m);
        let msgBubble;
        let CurrentUser = "@User.Identity.Name";
            console.log('addMessage run');
            //console.log(newMessage);
            if (m.Sender === CurrentUser) {

                msgBubble = '<div class="outgoing_msg">' +
                    '<div class="sent_msg">' +
                    '<span class="time_user">' + m.Sender + '</span>' +
                    '<p>' + m.Text + '</p>' +
                    '<span class="time_user">' + m.DateTime + '</span>' +
                    '</div></div></div>';
            } else {
                msgBubble = '<div class="incoming_msg">' +
                    '<div class="received_msg">' +
                    '<div class="received_withd_msg">' +
                    '<span class="time_user">' + m.Sender + '</span>' +
                    '<p>' + m.Text + '</p>' +
                    '<span class="time_user">' + m.DateTime + '</span>' +
                    '</div></div></div>';
            }
        return msgBubble;
    }

    //var msg = document.getElementById("msg");
    //msg.addEventListener("keyup", (event) => {
    //    console.log("enter pressed");
    //    event.preventDefault();
    //    if (event.keyCode === 13) {
    //        sendBtn();
    //    }
    //});
    //window.addEventListener("load", () => {


    //    let chatBox = document.getElementById("chatBox");
    //    const btn = document.getElementById("btn")

    //    msg.addEventListener("keyup", (event) => {
    //        event.preventDefault();
    //        if (event.keyCode === 13) {
    //            let msg = document.getElementById("msg");

    //            chatBox.innerHTML += `
    //                       <div class="outgoing_msg">
    //                            <div class="sent_msg">
    //                                <p>
    //                                    ${msg.value}
    //                                </p>
    //                                <span class="time_date"> 11:01 AM | June 9</span>
    //                            </div>
    //                       </div>`;
    //            msg.value = "";
    //        }
    //    });

    //    btn.addEventListener("click", () => {
    //        let msg = document.getElementById("msg");
    //        chatBox.innerHTML += `
    //                       <div class="outgoing_msg">
    //                            <div class="sent_msg">
    //                                <p>
    //                                    ${msg.value}
    //                                </p>
    //                                <span class="time_date"> 11:01 AM | June 9</span>
    //                            </div>
    //                       </div>`;
    //        msg.value = "";
    //    });

    //});
    window.addEventListener("load", () => {
        message();
    });
</script>
    }



